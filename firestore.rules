rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function getPocket(pocketId) {
      return get(/databases/$(database)/documents/pockets/$(pocketId));
    }

    function pocketExists(pocketId) {
      return exists(/databases/$(database)/documents/pockets/$(pocketId));
    }

    function isPocketParticipant(pocketId) {
      return isSignedIn()
        && pocketId is string
        && pocketExists(pocketId)
        && ('participants' in getPocket(pocketId).data)
        && (request.auth.uid in getPocket(pocketId).data.participants);
    }

    // Users can read/write their own user document
    // Users can also read other users' documents (for transaction display)
    match /users/{userId} {
      // Allow create for new user during signup (when document doesn't exist yet)
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Allow read/write for own document
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      
      // Allow read for other users' documents (for transaction display - user names only)
      allow read: if isSignedIn();
    }
    
    match /pockets/{pocketId} {
      // Allow reads only for participants of the pocket
      allow read: if isPocketParticipant(pocketId);
      
      // Allow creating a new pocket if the authenticated user is listed as a participant
      allow create: if isSignedIn()
        && ('participants' in request.resource.data)
        && (request.auth.uid in request.resource.data.participants);
      
      // Allow updates/deletes when the authenticated user is a current participant
      allow update, delete: if isSignedIn()
        && resource != null
        && ('participants' in resource.data)
        && (request.auth.uid in resource.data.participants);
    }
    
    match /transactions/{transactionId} {
      // Restrict reads to pocket participants only
      allow read: if resource != null
        && 'pocketId' in resource.data
        && isPocketParticipant(resource.data.pocketId);
      
      // Allow creates when the user owns the transaction and belongs to the pocket
      allow create: if isSignedIn()
        && ('userId' in request.resource.data)
        && ('pocketId' in request.resource.data)
        && (request.auth.uid == request.resource.data.userId)
        && isPocketParticipant(request.resource.data.pocketId);
      
      // Allow updates/deletes when the user owns the transaction and belongs to the pocket
      allow update, delete: if isSignedIn()
        && ('userId' in resource.data)
        && ('pocketId' in resource.data)
        && (request.auth.uid == resource.data.userId)
        && isPocketParticipant(resource.data.pocketId);
    }
  }
} 
